MODULE ZXWindows; IMPORT SYSTEM;

VAR
  SWTMP: INT8; (* Временный атрибут цвета *)
  SWPAP: INT8; (* Цвет бордюра *)
  SWCLS: INT8; (* Постоянный атрибут цвета *)

PROCEDURE CLS* (*__naked*);
BEGIN (*@__asm

; Очистка экрана и атрибутов
;  (SWPAP) - цвет бордюра, 0..7
;  (SWCLS) - код цвета фона

CLS:            LD      A, (_ZXWindows_SWPAP)  ; Берём цвет бордюра
                OUT     (0xFE), A              ; Установим бордюр
                LD      HL, #0x4000
                LD      (HL), L
                LD      DE, #0x4001
                LD      BC, #0x17FF
                LDIR                           ; Чистим экран (пиксельный слой)
                INC     HL
                LD      A, (_ZXWindows_SWCLS)  ; Берём постоянный цвет
                LD      (_ZXWindows_SWTMP), A  ; И устанавливаем им временный цвет
                LD      (HL), A
                INC     DE
                LD      BC, #0x2FF
                LDIR                           ; Чистим атрибутный слой постоянным цветом
                LD      HL, #DATA_95FC
                LD      DE, #0
                LD      BC, #0x820
                JP      _ZXWindows_SPRITE

DATA_95FC: .DB 0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA
           .DB 0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA
           .DB 0x55,0x03,0x1B,0x18,0xDD,0x00,0x55,0x00,0x06,0x75,0x20,0x00,0x55,0x00,0x0D,0x9C
           .DB 0x98,0x00,0x55,0x00,0x64,0x54,0x8C,0x00,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55
           .DB 0xAA,0x02,0xA8,0xA9,0x49,0x00,0xAA,0x00,0x05,0x47,0x50,0x00,0xAA,0x00,0x15,0x49
           .DB 0x54,0x00,0xAA,0x00,0x54,0x55,0x54,0x00,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA
           .DB 0x55,0x03,0x3B,0x29,0xC9,0x80,0x55,0x00,0x05,0x75,0x50,0x00,0x55,0x00,0x1D,0x89
           .DB 0x58,0x00,0x55,0x00,0x66,0x49,0x54,0x00,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55
           .DB 0xAA,0x02,0x28,0xA9,0x49,0x40,0xAA,0x00,0x05,0x45,0x50,0x00,0xAA,0x00,0x15,0x49
           .DB 0x50,0x00,0xAA,0x00,0x55,0x55,0x54,0x00,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA
           .DB 0x55,0x02,0x2B,0x7D,0x49,0x80,0x55,0x00,0x06,0x75,0x20,0x00,0x55,0x00,0x15,0x88
           .DB 0x90,0x00,0x55,0x00,0x66,0x54,0xBE,0x00,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55
           .DB 0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA
           .DB 0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0x00,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA,0xAA
           .DB 0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55
           .DB 0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55

__endasm;*)

END CLS;

PROCEDURE SPRITE;
BEGIN
; =============== S U B R O U T I N E =======================================
; Вывод двухцветного спрайта временным цветом
;  Вход: НL - адрес спрайта
;        DE - адрес экрана Y, X в знакоместах
;        В - кол-во байт по оси Y. С - кол-во байт по оси X
;  Выход: регистры НL, ВС, DE сохранены

SPRITE:         EX      AF, AF
                XOR     A
                EX      AF, AF
                PUSH    HL
                PUSH    DE
                PUSH    BC
                CALL    POSIT
                PUSH    DE
                EXX
                POP     DE
                EXX
LOC_834F:       PUSH    BC
                PUSH    DE
                LD      B, #0
                LDIR
                POP     DE
                POP     BC
                CALL    SUB_85D4
                EX      AF, AF
                INC     A
                EX      AF, AF
                DJNZ    LOC_834F
                EX      AF, AF
                SRL     A
                SRL     A
                SRL     A
                LD      H, A
                EX      AF, AF
                EXX
                PUSH    DE
                EXX
                POP     DE
                POP     BC
                PUSH    BC
                LD      B, H
                LD      A, D
                AND     #0x18
                RRCA
                RRCA
                RRCA
                OR      #0x58
                LD      H, A
                LD      L, E
                LD      DE, #0x20
                LD      A, (SWTMP)
LOC_837F:       PUSH    BC
                PUSH    HL
                LD      B, C
LOC_8382:       LD      (HL), A
                INC     HL
                DJNZ    LOC_8382
                POP     HL
                ADD     HL, DE
                POP     BC
                DJNZ    LOC_837F
                POP     BC
                POP     DE
                POP     HL
                RET


END SPRITE;

END ZXWindows.
